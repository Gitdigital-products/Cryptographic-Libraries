#include <stdio.h>
#include <string.h>
#include <stdlib.h>
#include "../../include/crypto_lib/hash.h"

// Simple hex string to binary conversion
static int hex2bin(const char *hex, uint8_t *bin, size_t bin_len) {
    size_t hex_len = strlen(hex);
    if (hex_len % 2 != 0 || hex_len / 2 > bin_len) {
        return -1;
    }
    
    for (size_t i = 0; i < hex_len; i += 2) {
        char byte_str[3] = {hex[i], hex[i+1], '\0'};
        char *endptr;
        bin[i/2] = (uint8_t)strtol(byte_str, &endptr, 16);
        if (*endptr != '\0') {
            return -1;
        }
    }
    return 0;
}

// Compare binary to hex string
static int compare_bin_to_hex(const uint8_t *bin, size_t bin_len, const char *hex) {
    uint8_t expected[bin_len];
    if (hex2bin(hex, expected, bin_len) != 0) {
        return -1;
    }
    return memcmp(bin, expected, bin_len) == 0 ? 0 : 1;
}

// Print hexdump
static void print_hex(const char *label, const uint8_t *data, size_t len) {
    printf("%s: ", label);
    for (size_t i = 0; i < len; i++) {
        printf("%02x", data[i]);
    }
    printf("\n");
}

// Test case structure
typedef struct {
    const char *message_hex;
    const char *expected_hex;
    const char *description;
} test_case;

// Test cases from FIPS 180-4
static const test_case test_cases[] = {
    {
        "",
        "e3b0c44298fc1c149afbf4c8996fb92427ae41e4649b934ca495991b7852b855",
        "Empty message"
    },
    {
        "616263",
        "ba7816bf8f01cfea414140de5dae2223b00361a396177a9cb410ff61f20015ad",
        "abc"
    },
    {
        "6162636462636465636465666465666765666768666768696768696a68696a6b696a6b6c6a6b6c6d6b6c6d6e6c6d6e6f6d6e6f706e6f7071",
        "248d6a61d20638b8e5c026930c3e6039a33ce45964ff2167f6ecedd419db06c1",
        "abcdbcdecdefdefgefghfghighijhijkijkljklmklmnlmnomnopnopq"
    }
};

int main() {
    printf("Running SHA-256 Known Answer Tests...\n");
    printf("=====================================\n\n");
    
    int passed = 0;
    int total = sizeof(test_cases) / sizeof(test_cases[0]);
    
    for (int i = 0; i < total; i++) {
        const test_case *tc = &test_cases[i];
        
        // Calculate message length from hex string
        size_t msg_len = strlen(tc->message_hex) / 2;
        uint8_t *message = malloc(msg_len);
        uint8_t digest[32];
        
        if (!message) {
            printf("Memory allocation failed for test %d\n", i + 1);
            continue;
        }
        
        // Convert hex message to binary
        if (hex2bin(tc->message_hex, message, msg_len) != 0) {
            printf("Failed to parse hex for test %d\n", i + 1);
            free(message);
            continue;
        }
        
        // Compute hash
        if (crypto_hash_sha256(digest, message, msg_len) != 0) {
            printf("Hash computation failed for test %d\n", i + 1);
            free(message);
            continue;
        }
        
        // Verify result
        if (compare_bin_to_hex(digest, 32, tc->expected_hex) == 0) {
            printf("✓ Test %d: %s\n", i + 1, tc->description);
            passed++;
        } else {
            printf("✗ Test %d: %s\n", i + 1, tc->description);
            print_hex("  Expected", (uint8_t*)tc->expected_hex, 64); // Hex string length
            print_hex("  Got     ", digest, 32);
        }
        
        free(message);
    }
    
    printf("\n=====================================\n");
    printf("Results: %d/%d tests passed\n", passed, total);
    
    if (passed == total) {
        printf("SUCCESS: All tests passed!\n");
        return 0;
    } else {
        printf("FAILURE: Some tests failed\n");
        return 1;
    }
}