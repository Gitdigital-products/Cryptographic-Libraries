name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]

jobs:
  build-and-test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y gcc clang make valgrind
        
    - name: Build with GCC
      run: |
        make CC=gcc
        
    - name: Build with Clang
      run: |
        make CC=clang
        
    - name: Run tests
      run: |
        make test
        
    - name: Run sanitized tests
      run: |
        make test-sanitize
        
    - name: Run Valgrind (memory leak check)
      run: |
        for test_file in tests/unit/*.c tests/kat/*.c; do \
          test_name=$$(basename $$test_file .c); \
          make CC=gcc; \
          gcc -std=c99 -I./include -I./tests $$test_file build/libcryptolib.a -o build/$$test_name; \
          valgrind --leak-check=full --error-exitcode=1 ./build/$$test_name || exit 1; \
        done
        
  fuzzing:
    runs-on: ubuntu-latest
    needs: build-and-test
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Install fuzzing dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y clang
        
    - name: Run fuzzer for 60 seconds
      run: |
        make fuzz
        timeout 60 ./build/fuzz_sha2 -max_total_time=60 || true